(()=>{"use strict";var e={83746:function(e,t,r){t.CronJob=void 0,r(92262);var n=r(98189);Object.defineProperty(t,"CronJob",{enumerable:!0,get:function(){return n.CronJob}}),r(92262)},70864:function(e){var t=Object.prototype.hasOwnProperty,r="~";function n(){}function s(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function o(e,t,n,o,i){if("function"!=typeof n)throw TypeError("The listener must be a function");var a=new s(n,o||e,i),l=r?r+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],a]:e._events[l].push(a):(e._events[l]=a,e._eventsCount++),e}function i(e,t){0==--e._eventsCount?e._events=new n:delete e._events[t]}function a(){this._events=new n,this._eventsCount=0}Object.create&&(n.prototype=Object.create(null),new n().__proto__||(r=!1)),a.prototype.eventNames=function(){var e,n,s=[];if(0===this._eventsCount)return s;for(n in e=this._events)t.call(e,n)&&s.push(r?n.slice(1):n);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},a.prototype.listeners=function(e){var t=r?r+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var s=0,o=n.length,i=Array(o);s<o;s++)i[s]=n[s].fn;return i},a.prototype.listenerCount=function(e){var t=r?r+e:e,n=this._events[t];return n?n.fn?1:n.length:0},a.prototype.emit=function(e,t,n,s,o,i){var a=r?r+e:e;if(!this._events[a])return!1;var l,c,u=this._events[a],d=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),d){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,n),!0;case 4:return u.fn.call(u.context,t,n,s),!0;case 5:return u.fn.call(u.context,t,n,s,o),!0;case 6:return u.fn.call(u.context,t,n,s,o,i),!0}for(c=1,l=Array(d-1);c<d;c++)l[c-1]=arguments[c];u.fn.apply(u.context,l)}else{var h,p=u.length;for(c=0;c<p;c++)switch(u[c].once&&this.removeListener(e,u[c].fn,void 0,!0),d){case 1:u[c].fn.call(u[c].context);break;case 2:u[c].fn.call(u[c].context,t);break;case 3:u[c].fn.call(u[c].context,t,n);break;case 4:u[c].fn.call(u[c].context,t,n,s);break;default:if(!l)for(h=1,l=Array(d-1);h<d;h++)l[h-1]=arguments[h];u[c].fn.apply(u[c].context,l)}}return!0},a.prototype.on=function(e,t,r){return o(this,e,t,r,!1)},a.prototype.once=function(e,t,r){return o(this,e,t,r,!0)},a.prototype.removeListener=function(e,t,n,s){var o=r?r+e:e;if(!this._events[o])return this;if(!t)return i(this,o),this;var a=this._events[o];if(a.fn)a.fn!==t||s&&!a.once||n&&a.context!==n||i(this,o);else{for(var l=0,c=[],u=a.length;l<u;l++)(a[l].fn!==t||s&&!a[l].once||n&&a[l].context!==n)&&c.push(a[l]);c.length?this._events[o]=1===c.length?c[0]:c:i(this,o)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&i(this,t)):(this._events=new n,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=r,a.EventEmitter=a,e.exports=a},15705:function(e,t,r){let n,s="undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),o=new Uint8Array(16),i=[];for(let e=0;e<256;++e)i.push((e+256).toString(16).slice(1));let a=function(e,t,r){var a;if(s&&!t&&!e)return s();let l=(e=e||{}).random??(null==(a=e.rng)?void 0:a.call(e))??function(){if(!n){if("undefined"==typeof crypto||!crypto.getRandomValues)throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");n=crypto.getRandomValues.bind(crypto)}return n(o)}();if(l.length<16)throw Error("Random bytes length must be >= 16");if(l[6]=15&l[6]|64,l[8]=63&l[8]|128,t){if((r=r||0)<0||r+16>t.length)throw RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[r+e]=l[e];return t}return function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(i[e[t+0]]+i[e[t+1]]+i[e[t+2]]+i[e[t+3]]+"-"+i[e[t+4]]+i[e[t+5]]+"-"+i[e[t+6]]+i[e[t+7]]+"-"+i[e[t+8]]+i[e[t+9]]+"-"+i[e[t+10]]+i[e[t+11]]+i[e[t+12]]+i[e[t+13]]+i[e[t+14]]+i[e[t+15]]).toLowerCase()}(l)};var l=r(70864);function c(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class u{postMessage(e){this.target.postMessage(e,"*")}constructor(e){c(this,"target",void 0),this.target=e}}class d{sendMessage(e){let t={messageId:this.messageId,type:"connectMessage",data:e};this.target.postMessage(t)}onMessage(e){this.EE.addListener(`connectMessage:${this.messageId}`,e)}disconnect(){let e={messageId:this.messageId,type:"disconnect",data:null};this.target.postMessage(e)}onDisconnect(e){this.EE.addListener(`disconnect:${this.messageId}`,e)}constructor(e,t,r){c(this,"messageId",void 0),c(this,"EE",void 0),c(this,"target",void 0),this.messageId=e,this.EE=t,this.target=r,this.onDisconnect(()=>{this.EE.removeAllListeners("connectMessage:"+this.messageId),this.EE.removeAllListeners("disconnect:"+this.messageId)})}}let h=/YYYY|MM|DD|HH|mm|ss/g;function p(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}let g={none:0,trace:10,debug:100,info:1e3,warn:1e4,error:1e5};class f{log(e,t){let r;for(var n=arguments.length,s=Array(n>2?n-2:0),o=2;o<n;o++)s[o-2]=arguments[o];let i=function(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];let n={};return t.forEach(e=>{e.forEach(e=>{Object.keys(e).forEach(t=>{n[t]=e[t]})})}),n}(this.label,s);g[e]>=g[this.core.level]&&this.core.writer.write(e,t,i);try{r=JSON.stringify(i)}catch(e){r=i,console.error("Logger label JSON stringify error:",e)}if("none"!==this.core.consoleLevel&&g[e]>=g[this.core.consoleLevel]){"object"==typeof t&&(t=JSON.stringify(t));let n=`${function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Date,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"YYYY-MM-DD HH:mm:ss";return t.replace(h,t=>{switch(t){case"YYYY":return e.getFullYear().toString();case"MM":{let t=e.getMonth()+1;return t<10?"0"+t:t.toString()}case"DD":{let t=e.getDate();return t<10?"0"+t:t.toString()}case"HH":{let t=e.getHours();return t<10?"0"+t:t.toString()}case"mm":{let t=e.getMinutes();return t<10?"0"+t:t.toString()}case"ss":{let t=e.getSeconds();return t<10?"0"+t:t.toString()}}return t})}(new Date,"YYYY-MM-DD HH:mm:ss")} [${e}] ${t}`;switch(e){case"error":console.error(n,r);break;case"warn":console.warn(n,r);break;default:console.info(n,r)}}}with(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new f(this.core,...this.label,...t)}trace(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];this.log("trace",e,...r)}debug(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];this.log("debug",e,...r)}info(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];this.log("info",e,...r)}warn(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];this.log("warn",e,...r)}error(e){for(var t=arguments.length,r=Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];this.log("error",e,...r)}static E(e){return"string"==typeof e?{error:e}:e instanceof Error?(console.error(e),{error:e.message}):"object"==typeof e?e:{}}constructor(e,...t){p(this,"core",void 0),p(this,"label",void 0),this.core=e,this.label=t}}function m(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class v{static getInstance(){return v.instance}static logger(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return v.getInstance().logger(...t)}logger(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return new f(this,this.labels,...t)}constructor(e){m(this,"writer",void 0),m(this,"level","info"),m(this,"consoleLevel","warn"),m(this,"labels",void 0),this.writer=e.writer,this.level=e.level||this.level,this.labels=e.labels||{},void 0!==e.consoleLevel&&(this.consoleLevel=e.consoleLevel),v.instance||(v.instance=this)}}function M(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}m(v,"instance",void 0);async function b(e,t,r){let n=await e.sendMessage({action:t,data:r}),s=v.getInstance().logger().with({action:t,data:r,response:n});if(s.trace("sendMessage"),null==n?void 0:n.code)throw console.error(n),n.message;try{return n.data}catch(e){s.trace("Invalid response data",f.E(e));return}}class y{sendMessage(e){this.con.postMessage(e)}onMessage(e){this.con.onMessage.addListener(e)}disconnect(){this.con.disconnect()}onDisconnect(e){this.con.onDisconnect.addListener(e)}getPort(){return this.con}constructor(e){var t;t=void 0,"con"in this?Object.defineProperty(this,"con",{value:t,enumerable:!0,configurable:!0,writable:!0}):this.con=t,this.con=e}}function w(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class _{getSender(){return this.sender instanceof y?this.sender.getPort().sender:this.sender}getExtMessageSender(){var e,t,r,n,s,o,i,a;if(this.sender instanceof y){let e=this.sender.getPort();return{windowId:(null==(n=e.sender)||null==(r=n.tab)?void 0:r.windowId)||-1,tabId:(null==(o=e.sender)||null==(s=o.tab)?void 0:s.id)||-1,frameId:null==(i=e.sender)?void 0:i.frameId,documentId:null==(a=e.sender)?void 0:a.documentId}}let l=this.sender;return{windowId:(null==(e=l.tab)?void 0:e.windowId)||-1,tabId:(null==(t=l.tab)?void 0:t.id)||-1,frameId:l.frameId,documentId:l.documentId}}getConnect(){return this.sender}constructor(e){w(this,"sender",void 0),this.sender=e}}class G{group(e,t){return new I(this,e,t)}on(e,t){this.apiFunctionMap.set(e,t)}connectHandle(e,t,r){let n=this.apiFunctionMap.get(e);if(n){let e=n(t,new _(r));return e&&(e instanceof Promise?e.then(e=>{e&&r.sendMessage({code:0,data:e})}).catch(e=>{r.sendMessage({code:-1,message:e.message||e.toString()}),this.logger.error("connectHandle error",f.E(e))}):r.sendMessage({code:0,data:e})),!0}}messageHandle(e,t,r,n){let s=this.apiFunctionMap.get(e);if(s)try{let e=s(t,new _(n));if(e instanceof Promise)return e.then(e=>{try{r({code:0,data:e})}catch(e){this.logger.error("sendResponse error",f.E(e))}}).catch(e=>{r({code:-1,message:e.message||e.toString()}),this.logger.error("messageHandle error",f.E(e))}),!0;r({code:0,data:e})}catch(e){r({code:-1,message:e.message||e.toString()}),this.logger.error("messageHandle error",f.E(e))}else r({code:-1,message:"no such api "+e}),this.logger.error("no such api",{action:e})}constructor(e,t,r=!0){w(this,"enableConnect",void 0),w(this,"apiFunctionMap",void 0),w(this,"logger",void 0),this.enableConnect=r,this.apiFunctionMap=new Map,this.logger=v.getInstance().logger({service:"messageServer"}),this.enableConnect&&t.onConnect((t,r)=>{var n;if("string"==typeof t.action)return this.logger.trace("server onConnect",{msg:t}),null!=(n=t.action)&&!!n.startsWith(e)&&this.connectHandle(t.action.slice(e.length+1),t.data,r)}),t.onMessage((t,r,n)=>{var s;if("string"==typeof t.action)return this.logger.trace("server onMessage",{msg:t}),null!=(s=t.action)&&!!s.startsWith(e)&&this.messageHandle(t.action.slice(e.length+1),t.data,r,n)})}}class I{group(e,t){let r=new I(this.server,`${this.name}${e}`,t);return r.middlewares=[...this.middlewares,...r.middlewares],r}use(e){let t=new I(this.server,`${this.name}`,e);return t.middlewares=[...this.middlewares,...t.middlewares],t}on(e,t){let r=`${this.name}${e}`;0===this.middlewares.length?this.server.on(r,t):this.server.on(r,async(e,r)=>{let n=0,s=async()=>{if(!(n<this.middlewares.length))return await t(e,r);{let t=this.middlewares[n++];return await t(e,r,s)}};return await s()})}constructor(e,t,r){w(this,"server",void 0),w(this,"name",void 0),w(this,"middlewares",void 0),this.server=e,this.name=t,this.middlewares=[],!t.endsWith("/")&&t.length>0&&(this.name+="/"),r&&this.middlewares.push(r)}}function A(e,t){return b(e,"offscreen/sendMessageToServiceWorker",{action:"script/updateRunStatus",data:t})}let C="complete";var x=r(83746);let E=new Map;function T(e,t,r,n){let s=E.get(e);s||E.set(e,s=[]),s.push({fnKey:t,api:r,param:n})}let P={};class S{static protected(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0;return(t,r)=>{P[r]=e}}static API(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return(t,r,n)=>{let{follow:s}=e,{alias:o}=e;s||(s=r),T(s,r,n.value,e),o&&T(o,o,n.value,e)}}}function k(e){var t;let r=null==(t=e.metadata)?void 0:t.storagename;return r?r[0]:e.uuid}function R(e){let t=e.indexOf("==UserScript=="),r=e.indexOf("==/UserScript==");return -1===t||-1===r?null:`// ${e.substring(t,r+15)}`}function L(e){let t=e.indexOf("==UserConfig=="),r=e.indexOf("==/UserConfig==");return -1===t||-1===r?null:`/* ${e.substring(t,r+15)} */`}function O(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function j(e,t,r,n){var s,o=arguments.length,i=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(i=(o<3?s(i):o>3?s(t,r,i):s(t,r))||i);return o>3&&i&&Object.defineProperty(t,r,i),i}let U={};class D{static createGMBase(e){return new D(e,U)}async sendMessage(e,t){return this.loadScriptPromise&&await this.loadScriptPromise,b(this.message,`${this.prefix}/runtime/gmApi`,{uuid:this.scriptRes.uuid,api:e,params:t,runFlag:this.runFlag})}connect(e,t){var r,n,s;return r=this.message,n=`${this.prefix}/runtime/gmApi`,s={uuid:this.scriptRes.uuid,api:e,params:t,runFlag:this.runFlag},r.connect({action:n,data:s})}valueUpdate(e){(e.uuid===this.scriptRes.uuid||e.storageName===k(this.scriptRes))&&(void 0===e.value?void 0!==this.scriptRes.value[e.key]&&delete this.scriptRes.value[e.key]:this.scriptRes.value[e.key]=e.value,this.valueChangeListener.forEach(t=>{t.name===e.key&&t.listener(e.key,e.oldValue,e.value,e.sender.runFlag!==this.runFlag,e.sender.tabId)}))}emitEvent(e,t,r){this.EE.emit(`${e}:${t}`,r)}constructor(e=null,t=null){if(O(this,"runFlag",void 0),O(this,"prefix",void 0),O(this,"message",void 0),O(this,"scriptRes",void 0),O(this,"valueChangeListener",void 0),O(this,"EE",void 0),O(this,"context",void 0),O(this,"grantSet",void 0),O(this,"eventId",void 0),O(this,"loadScriptResolve",void 0),O(this,"loadScriptPromise",void 0),t!==U)throw TypeError("Illegal invocation");Object.assign(this,e)}}j([S.protected()],D.prototype,"runFlag",void 0),j([S.protected()],D.prototype,"prefix",void 0),j([S.protected()],D.prototype,"message",void 0),j([S.protected()],D.prototype,"scriptRes",void 0),j([S.protected()],D.prototype,"valueChangeListener",void 0),j([S.protected()],D.prototype,"EE",void 0),j([S.protected()],D.prototype,"context",void 0),j([S.protected()],D.prototype,"grantSet",void 0),j([S.protected()],D.prototype,"eventId",void 0),j([S.protected()],D.prototype,"loadScriptResolve",void 0),j([S.protected()],D.prototype,"loadScriptPromise",void 0),j([S.protected()],D,"createGMBase",null),j([S.protected()],D.prototype,"sendMessage",null),j([S.protected()],D.prototype,"connect",null),j([S.protected()],D.prototype,"valueUpdate",null),j([S.protected()],D.prototype,"emitEvent",null);class V extends D{static _GM_getValue(e,t,r){let n=e.scriptRes.value[t];return void 0!==n?n:r}GM_getValue(e,t){return B(this,e,t)}"GM.getValue"(e,t){return new Promise(r=>{r(B(this,e,t))})}static _GM_setValue(e,t,r){"object"==typeof r&&(r=JSON.parse(JSON.stringify(r))),void 0===r?(delete e.scriptRes.value[t],e.sendMessage("GM_setValue",[t])):(e.scriptRes.value[t]=r,e.sendMessage("GM_setValue",[t,r]))}GM_setValue(e,t){H(this,e,t)}"GM.setValue"(e,t){return new Promise(r=>{H(this,e,t),r()})}GM_deleteValue(e){H(this,e,void 0)}"GM.deleteValue"(e){return new Promise(t=>{H(this,e,void 0),t()})}GM_listValues(){return Object.keys(this.scriptRes.value)}"GM.listValues"(){return new Promise(e=>{e(Object.keys(this.scriptRes.value))})}GM_setValues(e){if(null==e)throw Error("GM_setValues: values must not be null or undefined");if("object"!=typeof e)throw Error("GM_setValues: values must be an object");for(let t of Object.keys(e)){let r=e[t];H(this,t,r)}}GM_getValues(e){if(null==e)return this.scriptRes.value;let t={};if(Array.isArray(e))for(let r=0;r<e.length;r++){let n=e[r];n in this.scriptRes.value&&(t[n]=this.scriptRes.value[n])}else for(let r of Object.keys(e)){let n=e[r];t[r]=B(this,r,n)}return t}"GM.getValues"(e){return new Promise(t=>{t(this.GM_getValues(e))})}"GM.setValues"(e){return new Promise(t=>{this.GM_setValues(e),t()})}GM_deleteValues(e){if(!Array.isArray(e))return void console.warn("GM_deleteValues: keys must be string[]");for(let t of e)H(this,t,void 0)}"GM.deleteValues"(e){return new Promise(t=>{this.GM_deleteValues(e),t()})}GM_addValueChangeListener(e,t){return this.eventId+=1,this.valueChangeListener.set(this.eventId,{name:e,listener:t}),this.eventId}GM_removeValueChangeListener(e){this.valueChangeListener.delete(e)}GM_log(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info";for(var r=arguments.length,n=Array(r>2?r-2:0),s=2;s<r;s++)n[s-2]=arguments[s];"string"!=typeof e&&(e=JSON.stringify(e));let o=[e,t];n.length>0&&o.push(n),this.sendMessage("GM_log",o)}CAT_createBlobUrl(e){return this.sendMessage("CAT_createBlobUrl",[e])}CAT_fetchBlob(e){return this.sendMessage("CAT_fetchBlob",[e])}async CAT_fetchDocument(e){let t=await this.sendMessage("CAT_fetchDocument",[e]);return this.message.getAndDelRelatedTarget(t.relatedTarget)}static _GM_cookie(e,t,r,n){r.url||r.domain||(r.url=window.location.href),"set"!==t&&"delete"!==t||r.url||(r.url=window.location.href),e.sendMessage("GM_cookie",[t,r]).then(e=>{n&&n(e,void 0)}).catch(e=>{n&&n(void 0,e)})}"GM.cookie"(e,t){return new Promise((r,n)=>{F(this,e,t,(e,t)=>{t?n(t):r(e)})})}"GM.cookie.set"(e){return new Promise((t,r)=>{F(this,"set",e,(e,n)=>{n?r(n):t(e)})})}"GM.cookie.list"(e){return new Promise((t,r)=>{F(this,"list",e,(e,n)=>{n?r(n):t(e)})})}"GM.cookie.delete"(e){return new Promise((t,r)=>{F(this,"delete",e,(e,n)=>{n?r(n):t(e)})})}"GM_cookie.set"(e,t){F(this,"set",e,t)}"GM_cookie.list"(e,t){F(this,"list",e,t)}"GM_cookie.delete"(e,t){F(this,"delete",e,t)}GM_cookie(e,t,r){F(this,e,t,r)}GM_registerMenuCommand(e,t,r){if(this.menuMap||(this.menuMap=new Map),"object"==typeof r){let n=r;if(n.id&&this.menuMap.has(n.id))return this.EE.removeAllListeners("menuClick:"+n.id),this.EE.addListener("menuClick:"+n.id,t),this.sendMessage("GM_registerMenuCommand",[n.id,e,n]),n.id}else{r={accessKey:r};let t=0;if(this.menuMap.forEach((r,n)=>{r===e&&(t=n)}),t)return t}this.eventId+=1;let n=this.eventId;return r.id=n,this.menuMap.set(n,e),this.EE.addListener("menuClick:"+n,t),this.sendMessage("GM_registerMenuCommand",[n,e,r]),n}CAT_registerMenuInput(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.GM_registerMenuCommand(...t)}GM_addStyle(e){let t=this.message.syncSendMessage({action:`${this.prefix}/runtime/gmApi`,data:{uuid:this.scriptRes.uuid,api:"GM_addElement",params:[null,"style",{textContent:e}]}});if(t.code)throw Error(t.message);return this.message.getAndDelRelatedTarget(t.data)}GM_addElement(e,t,r){let n=e;n="string"!=typeof n?this.message.sendRelatedTarget(n):null;let s=this.message.syncSendMessage({action:`${this.prefix}/runtime/gmApi`,data:{uuid:this.scriptRes.uuid,api:"GM_addElement",params:[n,"string"==typeof e?e:t,"string"==typeof e?t:r]}});if(s.code)throw Error(s.message);return this.message.getAndDelRelatedTarget(s.data)}GM_unregisterMenuCommand(e){this.menuMap||(this.menuMap=new Map),this.menuMap.delete(e),this.EE.removeAllListeners("menuClick:"+e),this.sendMessage("GM_unregisterMenuCommand",[e])}CAT_unregisterMenuInput(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];this.GM_unregisterMenuCommand(...t)}CAT_userConfig(){return this.sendMessage("CAT_userConfig",[])}async CAT_fileStorage(e,t){if("config"===e)return void this.sendMessage("CAT_fileStorage",["config"]);let r={baseDir:t.baseDir||"",path:t.path||"",filename:t.filename,file:t.file};"upload"===e&&(r.data=await this.CAT_createBlobUrl(t.data)),this.sendMessage("CAT_fileStorage",[e,r]).then(async r=>{switch(r.action){case"onload":if("download"===e){let e=await this.CAT_fetchBlob(r.data);t.onload&&t.onload(e)}else t.onload&&t.onload(r.data);break;case"error":if(void 0===r.data.code){t.onerror&&t.onerror({code:-1,message:r.data.message});return}t.onerror&&t.onerror(r.data)}})}static _GM_xmlhttpRequest(e,t){let r,n=new URL(t.url,window.location.href),s=t.headers;if(s)for(let e of Object.keys(s))"cookie"===e.toLowerCase()&&(t.cookie=s[e],delete s[e]);let o={method:t.method,timeout:t.timeout,url:n.href,headers:t.headers,cookie:t.cookie,context:t.context,responseType:t.responseType,overrideMimeType:t.overrideMimeType,anonymous:t.anonymous,user:t.user,password:t.password,redirect:t.redirect};return o.headers||(o.headers={}),t.nocache&&(o.headers["Cache-Control"]="no-cache"),(async()=>{var n;let s,i;if(t.data instanceof FormData){o.dataType="FormData";let r={};t.data.forEach((e,t)=>{r[t]=!0}),o.data=await Promise.all(Object.keys(r).flatMap(r=>t.data.getAll(r).map(t=>t instanceof File?e.CAT_createBlobUrl(t).then(e=>({key:r,type:"file",val:e,filename:t.name})):{key:r,type:"text",val:t})))}else t.data instanceof Blob?(o.dataType="Blob",o.data=await e.CAT_createBlobUrl(t.data)):o.data=t.data;let a=null==(n=t.responseType)?void 0:n.toLocaleLowerCase(),l=t=>("stream"===a&&(s=new ReadableStream({start(e){i=e}})),async r=>{if(r.response)if("document"===a)r.response=await e.CAT_fetchDocument(r.response),r.responseXML=r.response,r.responseType="document";else{let t=await e.CAT_fetchBlob(r.response);"arraybuffer"===a?r.response=await t.arrayBuffer():r.response=t}"stream"===a&&(r.response=s),t(r)});("arraybuffer"===a||"blob"===a||"document"===a||"stream"===a)&&(t.onload&&(t.onload=l(t.onload)),t.onreadystatechange&&(t.onreadystatechange=l(t.onreadystatechange)),t.onloadend&&(t.onloadend=l(t.onloadend)),"document"===a&&(o.responseType="blob"),"stream"===a&&t.onloadstart&&(t.onloadstart=l(t.onloadstart))),e.connect("GM_xmlhttpRequest",[o]).then(e=>{r=e,e.onMessage(e=>{var r,n,s,o,a,l,c;if(-1===e.code){v.logger().error("GM_xmlhttpRequest error",{code:e.code,message:e.message}),t.onerror&&t.onerror({readyState:4,error:e.message||"unknown"});return}switch(e.action){case"onload":null==(r=t.onload)||r.call(t,e.data);break;case"onloadend":null==(n=t.onloadend)||n.call(t,e.data);break;case"onloadstart":null==(s=t.onloadstart)||s.call(t,e.data);break;case"onprogress":null==(o=t.onprogress)||o.call(t,e.data);break;case"onreadystatechange":t.onreadystatechange&&t.onreadystatechange(e.data);break;case"ontimeout":null==(a=t.ontimeout)||a.call(t);break;case"onerror":null==(l=t.onerror)||l.call(t,e.data);break;case"onabort":null==(c=t.onabort)||c.call(t);break;case"onstream":null==i||i.enqueue(new Uint8Array(e.data));break;default:v.logger().warn("GM_xmlhttpRequest resp is error",{data:e})}})})})(),{abort:()=>{r&&r.disconnect()}}}GM_xmlhttpRequest(e){return N(this,e)}"GM.xmlHttpRequest"(e){let t,r=new Promise((r,n)=>{let s=e.onload;e.onloadend=e=>{s&&s(e),r(e)};let o=e.onerror;e.onerror=e=>{o&&o(e),n(e)},t=N(this,e)});return r.abort=()=>{t&&t.abort&&t.abort()},r}GM_download(e,t){let r,n;return r="string"==typeof e?{name:t||"",url:e}:e,this.connect("GM_download",[{method:r.method,downloadMode:r.downloadMode||"native",url:r.url,name:r.name,headers:r.headers,saveAs:r.saveAs,timeout:r.timeout,cookie:r.cookie,anonymous:r.anonymous}]).then(e=>{(n=e).onMessage(e=>{switch(e.action){case"onload":r.onload&&r.onload(e.data);break;case"onprogress":r.onprogress&&r.onprogress(e.data);break;case"ontimeout":r.ontimeout&&r.ontimeout();break;case"onerror":r.onerror&&r.onerror({error:"unknown"});break;default:v.logger().warn("GM_download resp is error",{data:e})}})}),{abort:()=>{null==n||n.disconnect()}}}async GM_notification(e,t,r,n){let s,o,i,a,l,c=this.notificationTagMap||(this.notificationTagMap=new Map);if(this.eventId+=1,"string"==typeof e)switch((s={}).text=e,arguments.length){case 4:s.onclick=n;case 3:s.image=r;case 2:s.title=t}else(s=Object.assign({},e)).ondone=s.ondone||t;s.onclick&&(o=s.onclick,delete s.onclick),s.ondone&&(i=s.ondone,delete s.ondone),s.oncreate&&(a=s.oncreate,delete s.oncreate),"string"==typeof s.tag&&(l=c.get(s.tag)),this.sendMessage("GM_notification",[s,l]).then(e=>{a&&a.apply({id:e},[e]),"string"==typeof s.tag&&c.set(s.tag,e);let t=!1;this.EE.addListener("GM_notification:"+e,r=>{switch(r.event){case"click":case"buttonClick":{let n={event:r.event,id:e,isButtonClick:"buttonClick"===r.event,buttonClickIndex:r.params.index,byUser:r.params.byUser,preventDefault:function(){t=!0},highlight:s.highlight,image:s.image,silent:s.silent,tag:s.tag,text:s.tag,timeout:s.timeout,title:s.title,url:s.url};o&&o.apply({id:e},[n]),i&&i.apply({id:e},[]),t||"string"!=typeof s.url||(window.open(s.url,"_blank"),v.logger().info("GM_notification open url："+s.url,{data:s}));break}case"close":i&&i.apply({id:e},[r.params.byUser]),"string"==typeof s.tag&&c.delete(s.tag),this.EE.removeAllListeners("GM_notification:"+this.eventId);break;default:v.logger().warn("GM_notification resp is error",{resp:r})}})})}GM_closeNotification(e){this.sendMessage("GM_closeNotification",[e])}GM_updateNotification(e,t){this.sendMessage("GM_updateNotification",[e,t])}GM_openInTab(e,t){let r,n={};1==arguments.length?n.active=!0:"boolean"==typeof t?n.active=!t:n=t,void 0===n.active&&(n.active=!0);let s={close:()=>{r&&this.GM_closeInTab(r)},closed:!1,onclose(){}};return this.sendMessage("GM_openInTab",[e,n]).then(e=>{e?(r=e,this.EE.addListener("GM_openInTab:"+e,t=>{switch(t.event){case"oncreate":r=t.tabId;break;case"onclose":s.onclose&&s.onclose(),s.closed=!0,this.EE.removeAllListeners("GM_openInTab:"+e);break;default:v.logger().warn("GM_openInTab resp is error",{resp:t})}})):(s.onclose&&s.onclose(),s.closed=!0)}),s}GM_closeInTab(e){return this.sendMessage("GM_closeInTab",[e])}GM_getTab(e){this.sendMessage("GM_getTab",[]).then(t=>{e(t??{})})}"GM.getTab"(){return new Promise(e=>{this.GM_getTab(t=>{e(t)})})}GM_saveTab(e){"object"==typeof e&&(e=JSON.parse(JSON.stringify(e))),this.sendMessage("GM_saveTab",[e])}GM_getTabs(e){this.sendMessage("GM_getTabs",[]).then(t=>{e(t)})}"GM.getTabs"(){return new Promise(e=>{this.GM_getTabs(t=>{e(t)})})}GM_setClipboard(e,t,r){this.sendMessage("GM_setClipboard",[e,t]).then(()=>{"function"==typeof r&&r()}).catch(()=>{"function"==typeof r&&r()})}"GM.setClipboard"(e,t){return this.sendMessage("GM_setClipboard",[e,t])}GM_getResourceText(e){if(!this.scriptRes.resource)return;let t=this.scriptRes.resource[e];if(t)return t.content}"GM.getResourceText"(e){return new Promise(t=>{t(this.GM_getResourceText(e))})}GM_getResourceURL(e,t){if(!this.scriptRes.resource)return;let r=this.scriptRes.resource[e];if(r){let e=r.base64;return(e||(e=`data:${r.contentType};base64,${btoa(encodeURIComponent(r.content).replace(/%([0-9A-F]{2})/g,(e,t)=>String.fromCharCode(parseInt(`0x${t}`,16))))}`),t)?URL.createObjectURL(function(e){let t=e.split(",")[0].split(":")[1].split(";")[0],r=atob(e.split(",")[1]),n=new Uint8Array(new ArrayBuffer(r.length));for(let e=0;e<r.length;e+=1)n[e]=r.charCodeAt(e);return new Blob([n],{type:t})}(e)):e}}"GM.getResourceUrl"(e,t){return new Promise(r=>{r(this.GM_getResourceURL(e,t))})}"window.close"(){return this.sendMessage("window.close",[])}"window.focus"(){return this.sendMessage("window.focus",[])}CAT_scriptLoaded(){return this.loadScriptPromise}constructor(e,t,r){super({prefix:e,message:t,scriptRes:r,valueChangeListener:new Map,EE:new l,notificationTagMap:new Map,eventId:0},U),O(this,"prefix",void 0),O(this,"message",void 0),O(this,"scriptRes",void 0),O(this,"notificationTagMap",void 0),O(this,"menuMap",void 0),O(this,"apiLoadPromise",void 0),this.prefix=e,this.message=t,this.scriptRes=r}}j([S.API()],V.prototype,"GM_getValue",null),j([S.API()],V.prototype,"GM.getValue",null),j([S.API()],V.prototype,"GM_setValue",null),j([S.API()],V.prototype,"GM.setValue",null),j([S.API()],V.prototype,"GM_deleteValue",null),j([S.API()],V.prototype,"GM.deleteValue",null),j([S.API()],V.prototype,"GM_listValues",null),j([S.API()],V.prototype,"GM.listValues",null),j([S.API()],V.prototype,"GM_setValues",null),j([S.API()],V.prototype,"GM_getValues",null),j([S.API({depend:["GM_getValues"]})],V.prototype,"GM.getValues",null),j([S.API({depend:["GM_setValues"]})],V.prototype,"GM.setValues",null),j([S.API()],V.prototype,"GM_deleteValues",null),j([S.API({depend:["GM_deleteValues"]})],V.prototype,"GM.deleteValues",null),j([S.API({alias:"GM.addValueChangeListener"})],V.prototype,"GM_addValueChangeListener",null),j([S.API({alias:"GM.removeValueChangeListener"})],V.prototype,"GM_removeValueChangeListener",null),j([S.API({alias:"GM.log"})],V.prototype,"GM_log",null),j([S.API()],V.prototype,"CAT_createBlobUrl",null),j([S.API()],V.prototype,"CAT_fetchBlob",null),j([S.API()],V.prototype,"CAT_fetchDocument",null),j([S.API({follow:"GM.cookie"})],V.prototype,"GM.cookie",null),j([S.API({follow:"GM.cookie"})],V.prototype,"GM.cookie.set",null),j([S.API({follow:"GM.cookie"})],V.prototype,"GM.cookie.list",null),j([S.API({follow:"GM.cookie"})],V.prototype,"GM.cookie.delete",null),j([S.API({follow:"GM_cookie"})],V.prototype,"GM_cookie.set",null),j([S.API({follow:"GM_cookie"})],V.prototype,"GM_cookie.list",null),j([S.API({follow:"GM_cookie"})],V.prototype,"GM_cookie.delete",null),j([S.API()],V.prototype,"GM_cookie",null),j([S.API({alias:"GM.registerMenuCommand"})],V.prototype,"GM_registerMenuCommand",null),j([S.API({depend:["GM_registerMenuCommand"]})],V.prototype,"CAT_registerMenuInput",null),j([S.API({alias:"GM.addStyle"})],V.prototype,"GM_addStyle",null),j([S.API({alias:"GM.addElement"})],V.prototype,"GM_addElement",null),j([S.API({alias:"GM.unregisterMenuCommand"})],V.prototype,"GM_unregisterMenuCommand",null),j([S.API({depend:["GM_unregisterMenuCommand"]})],V.prototype,"CAT_unregisterMenuInput",null),j([S.API()],V.prototype,"CAT_userConfig",null),j([S.API({depend:["CAT_fetchBlob","CAT_createBlobUrl"]})],V.prototype,"CAT_fileStorage",null),j([S.API({depend:["CAT_fetchBlob","CAT_createBlobUrl","CAT_fetchDocument"]})],V.prototype,"GM_xmlhttpRequest",null),j([S.API({depend:["CAT_fetchBlob","CAT_createBlobUrl","CAT_fetchDocument"]})],V.prototype,"GM.xmlHttpRequest",null),j([S.API({alias:"GM.download"})],V.prototype,"GM_download",null),j([S.API({depend:["GM_closeNotification","GM_updateNotification"],alias:"GM.notification"})],V.prototype,"GM_notification",null),j([S.API({alias:"GM.closeNotification"})],V.prototype,"GM_closeNotification",null),j([S.API({alias:"GM.updateNotification"})],V.prototype,"GM_updateNotification",null),j([S.API({depend:["GM_closeInTab"],alias:"GM.openInTab"})],V.prototype,"GM_openInTab",null),j([S.API({alias:"GM.closeInTab"})],V.prototype,"GM_closeInTab",null),j([S.API()],V.prototype,"GM_getTab",null),j([S.API({depend:["GM_getTab"]})],V.prototype,"GM.getTab",null),j([S.API({alias:"GM.saveTab"})],V.prototype,"GM_saveTab",null),j([S.API()],V.prototype,"GM_getTabs",null),j([S.API({depend:["GM_getTabs"]})],V.prototype,"GM.getTabs",null),j([S.API({})],V.prototype,"GM_setClipboard",null),j([S.API({depend:["GM_setClipboard"]})],V.prototype,"GM.setClipboard",null),j([S.API()],V.prototype,"GM_getResourceText",null),j([S.API({depend:["GM_getResourceText"]})],V.prototype,"GM.getResourceText",null),j([S.API()],V.prototype,"GM_getResourceURL",null),j([S.API({depend:["GM_getResourceURL"]})],V.prototype,"GM.getResourceUrl",null),j([S.API()],V.prototype,"window.close",null),j([S.API()],V.prototype,"window.focus",null),j([S.protected()],V.prototype,"apiLoadPromise",void 0),j([S.API()],V.prototype,"CAT_scriptLoaded",null);let{createGMBase:$}=D,{_GM_getValue:B,_GM_cookie:F,_GM_setValue:H,_GM_xmlhttpRequest:N}=V,J={this:!0,arguments:!0,[Symbol.unscopables]:!0},Y=new Set(["eval","window","self","globalThis","top","parent"]),W=Object.getOwnPropertyDescriptors(r.g),q={},K={};for(var Q=r.g,X=e=>{let[t,n]=e;if(!(!n||Y.has(t))&&"string"==typeof t){if(Y.add(t),n.writable){let e=n.value;if((e=>{if("function"!=typeof e||"prototype"in e)return!1;let{name:t}=e;if(!t)return!1;let r=t.charCodeAt(0);return r>=97&&r<=122})(e)){let s=e.bind(r.g);q[t]={...n,value:s}}}else if(n.configurable&&n.get&&n.set&&n.enumerable&&t.startsWith("on"))K[t]=n;else if(n.get||n.set){var s,o;q[t]={...n,get:null==n||null==(s=n.get)?void 0:s.bind(r.g),set:null==n||null==(o=n.set)?void 0:o.bind(r.g)}}}};Q&&Q!==Object;)Object.entries(Object.getOwnPropertyDescriptors(Q)).forEach(X),Q=Object.getPrototypeOf(Q);Y.clear();let z=Object.create(null,{...W,...q});function Z(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class ee{emitEvent(e,t,r){var n;this.logger.debug("emit event",{event:e,eventId:t,data:r}),null==(n=this.sandboxContext)||n.emitEvent(e,t,r)}valueUpdate(e){var t;null==(t=this.sandboxContext)||t.valueUpdate(e)}exec(){this.logger.debug("script start");let e=this.sandboxContext;return this.execContext=e?(e=>{let t,n=Object.getOwnPropertyDescriptors(z),s=e=>function(){let n=e.call(r.g);return n===r.g?t:n},o=e=>{let n=e.slice(2),s={fn:null,handleEvent(o){let i=t[e];i&&i===this.fn?i.call(t,o):(r.g.removeEventListener(n,s),this.fn=null)}};return{get:()=>s.fn,set(e){let{fn:t}=s;if(e!==t){let o;(o=e)!==Object(o)&&(e=null),typeof t!=typeof e&&("function"==typeof t?r.g.removeEventListener(n,s):"function"==typeof e&&r.g.addEventListener(n,s)),s.fn=e}}}};for(let e of Object.keys(K)){let t=o(e);n[e]={...n[e],...t}}for(let e of["window","self","globalThis","top","parent"]){let o=n[e];(null==o?void 0:o.value)===r.g?(o.get=function(){return t},o.set=void 0,delete o.writable,delete o.value):(null==o?void 0:o.get)&&(o.get=s(o.get),o.set=void 0)}for(let e of(n.$={enumerable:!1,configurable:!0,get(){return delete this.$,t}},(t=Object.create(Object.getPrototypeOf(z),n))[Symbol.unscopables]={...t[Symbol.unscopables]||{},...J},["define","module","exports"]))t[e]=void 0;for(let r of Object.keys(e))r in P||"window"===r||(t[r]=e[r]);let i=e.window;return(null==i?void 0:i.close)&&(t.close=i.close),(null==i?void 0:i.focus)&&(t.focus=i.focus),(null==i?void 0:i.onurlchange)===null&&(t.onurlchange=null),t})(e):r.g,this.scriptFunc.call(this.execContext,this.named,this.scriptRes.name)}dealEarlyScript(e){var t,r,n;let s;this.sandboxContext?(null==(t=(r=this.sandboxContext).loadScriptResolve)||t.call(r),s=this.execContext.GM_info):s=null==(n=this.named)?void 0:n.GM_info,s.isIncognito=e.isIncognito,s.sandboxMode=e.sandboxMode,s.userAgentData=e.userAgentData}stop(){return this.logger.debug("script stop"),!0}constructor(e,t,r,n,s,o){Z(this,"scriptRes",void 0),Z(this,"scriptFunc",void 0),Z(this,"logger",void 0),Z(this,"sandboxContext",void 0),Z(this,"named",void 0),Z(this,"execContext",void 0),this.scriptRes=e,this.logger=v.getInstance().logger({component:"exec",uuid:e.uuid,name:e.name});let i=function(e,t){var r,n,s,o,i;let a={description:(null==(r=t.metadata.description)?void 0:r[0])||null,matches:t.metadata.match||[],includes:t.metadata.include||[],"run-at":(null==(n=t.metadata["run-at"])?void 0:n[0])||"document-idle","run-in":t.metadata["run-in"]||[],icon:(null==(s=t.metadata.icon)?void 0:s[0])||null,icon64:(null==(o=t.metadata.icon64)?void 0:o[0])||null,header:t.metadataStr,grant:t.metadata.grant||[],connects:t.metadata.connect||[]};return{downloadMode:"native",isIncognito:e.isIncognito,sandboxMode:e.sandboxMode,scriptWillUpdate:!0,scriptHandler:"ScriptCat",userAgentData:e.userAgentData,scriptUpdateURL:t.downloadUrl||null,scriptMetaStr:t.metadataStr,userConfig:t.userConfig,userConfigStr:t.userConfigStr,version:"1.1.1",script:{name:t.name,namespace:t.namespace,version:null==(i=t.metadata.version)?void 0:i[0],author:t.author,lastModified:t.updatetime,downloadURL:t.downloadUrl||null,updateURL:t.checkUpdateUrl||null,...a}}}(s,e);"string"==typeof n?this.scriptFunc=Function(n):this.scriptFunc=n;let c=new Set(e.metadata.grant||[]);c.has("none")?this.named={GM:{info:i},GM_info:i}:(this.sandboxContext=((e,t,r,n,s)=>{let o,i,c=new Map,u=new l;e.metadata["run-at"]&&"document-start"===e.metadata["run-at"][0]&&e.metadata["early-start"]&&(o=new Promise(e=>{i=e}));let d=$({prefix:r,message:n,scriptRes:e,valueChangeListener:c,EE:u,runFlag:a(),eventId:1e4,GM:{info:t},GM_info:t,window:{},grantSet:new Set,loadScriptPromise:o,loadScriptResolve:i}),h={},p=e=>{let t=d.grantSet,r=E.get(e);if(!r)return!1;if(t.has(e))return!0;for(let{fnKey:n,api:s,param:o}of(t.add(e),r)){h[n]=s.bind(d);let e=null==o?void 0:o.depend;if(e)for(let t of e)p(t)}return!0};for(let e of s)p(e);for(let e of Object.keys(h)){let t=e.split("."),r=t.length,n=d,s="";for(let e=0;e<r;e++){let r=t[e];s+=`${e?".":""}${r}`,n=n[r]||(n[r]=h[s]||{})}}return d.unsafeWindow=window,d})(e,i,t,r,c),o&&Object.assign(this.sandboxContext,o))}}function et(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class er{constructor(e,t){et(this,"msg",void 0),et(this,"time",void 0),this.msg=e,"number"==typeof t?this.time=new Date(Date.now()+1e3*t):this.time=t}}class en extends ee{stop(){return this.setTimeout.forEach((e,t)=>{r.g.clearTimeout(t)}),this.setTimeout.clear(),this.setInterval.forEach((e,t)=>{r.g.clearInterval(t)}),this.setInterval.clear(),super.stop()}constructor(e,t){let n={},s=new Map,o=new Map;n.setTimeout=function(e,t){for(var n=arguments.length,o=Array(n>2?n-2:0),i=2;i<n;i++)o[i-2]=arguments[i];let a=r.g.setTimeout(function(){s.delete(a),"function"==typeof e&&e()},t,...o);return s.set(a,!0),a},n.clearTimeout=function(e){s.delete(e),r.g.clearTimeout(e)},n.setInterval=function(e,t){for(var n=arguments.length,s=Array(n>2?n-2:0),i=2;i<n;i++)s[i-2]=arguments[i];let a=r.g.setInterval(function(){"function"==typeof e&&e()},t,...s);return o.set(a,!0),a},n.clearInterval=function(e){o.delete(e),r.g.clearInterval(e)},n.CATRetryError=er,super(e,"offscreen",t,e.code,{sandboxMode:"raw",userAgentData:{brands:[],mobile:!1,platform:""},isIncognito:!1},n),et(this,"setTimeout",void 0),et(this,"setInterval",void 0),this.setTimeout=s,this.setInterval=o}}var es=r(9905);function eo(e){let t=/\/\*\s*==UserConfig==([\s\S]+?)\s*==\/UserConfig==\s*\*\//m.exec(e);if(!t)return;let r=t[1].trim().split(/[-]{3,}/),n={};for(let e of r){let t=(0,es.Qc)(e);if(t&&"object"==typeof t)for(let[e,r]of Object.entries(t)){if(!r||"object"!=typeof r)throw Error(`UserConfig group "${e}" is not a valid object.`);n[e]=r,Object.keys(n[e]||{}).forEach((t,r)=>{n[e][t]&&"object"==typeof n[e][t]&&(n[e][t].index=n[e][t].index||r)})}}return n}function ei(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class ea{joinRetryList(e){e.nextruntime&&(this.retryList.push({script:e,retryTime:e.nextruntime}),this.retryList.sort((e,t)=>e.retryTime-t.retryTime))}removeRetryList(e){for(let t=0;t<this.retryList.length;t+=1)this.retryList[t].script.uuid===e&&(this.retryList.splice(t,1),t-=1)}async enableScript(e){this.execScripts.has(e.uuid)&&await this.disableScript(e.uuid);let t=R(e.code)||"",r=L(e.code)||"",n=eo(r),s={...e,metadataStr:t,userConfigStr:r,userConfig:n};return 3===e.type?this.execScript(s):(this.stopCronJob(e.uuid),this.crontabScript(s))}disableScript(e){return this.stopCronJob(e),this.removeRetryList(e),A(this.windowMessage,{uuid:e,runStatus:C}),this.stopScript(e)}async execScript(e,t){let r=this.logger.with({uuid:e.uuid,name:e.name});this.execScripts.has(e.uuid)&&await this.stopScript(e.uuid);let n=new en(e,this.windowMessage);this.execScripts.set(e.uuid,n),A(this.windowMessage,{uuid:e.uuid,runStatus:"running"}),e.lastruntime=Date.now();let s=n.exec();return s instanceof Promise?s.then(t=>{A(this.windowMessage,{uuid:e.uuid,runStatus:C}),r.info("exec script complete",{value:t})}).catch(n=>{let s,o=0;throw n instanceof er?(s={error:n.msg},t||(e.nextruntime=o=n.time.getTime(),this.joinRetryList(e))):s=f.E(n),r.error("exec script error",s),A(this.windowMessage,{uuid:e.uuid,runStatus:"error",error:s,nextruntime:o}),n}):r.warn("backscript return not promise"),s}crontabScript(e){if(!e.metadata.crontab)throw Error(e.name+" - 错误的crontab表达式");this.joinRetryList(e),this.crontabSripts.push(e);let t=!1,r=[];if(e.metadata.crontab.forEach(n=>{let s=0,o=n;if(o.includes("once")){let e=o.split(" ");e.forEach((e,t)=>{"once"===e&&(s=t)}),5===e.length&&(s+=1),o=o.replace(/once/g,"*")}try{let t=new x.CronJob(o,this.crontabExec(e,s));t.start(),r.push(t)}catch(r){t=!0,this.logger.error("create cronjob failed",{uuid:e.uuid,crontab:n},f.E(r))}}),r.length!==e.metadata.crontab.length)for(let e of r)e.stop();else this.cronJob.set(e.uuid,r);return!t}crontabExec(e,t){return t?()=>{if(!e.lastruntime)return void this.execScript(e);let r=new Date,n=new Date(e.lastruntime),s=!1;switch(t){case 1:s=n.getMinutes()!==r.getMinutes();break;case 2:s=n.getHours()!==r.getHours();break;case 3:s=n.getDay()!==r.getDay();break;case 4:s=n.getMonth()!==r.getMonth();break;case 5:s=this.getWeek(n)!==this.getWeek(r)}s&&this.execScript(e)}:()=>{this.execScript(e)}}getWeek(e){let t=new Date(e),r=new Date(e);r.setMonth(0),r.setDate(1);let n=Math.ceil(Math.ceil((t.getTime()-r.getTime())/864e5)/7);return 0===n?1:n}stopCronJob(e){let t=this.cronJob.get(e);if(t){for(let e of t)e.stop();this.cronJob.delete(e)}this.crontabSripts=this.crontabSripts.filter(t=>t.uuid!==e)}async stopScript(e){let t=this.execScripts.get(e);return t?(t.stop(),this.execScripts.delete(e),A(this.windowMessage,{uuid:e,runStatus:C}),!0):(A(this.windowMessage,{uuid:e,runStatus:C}),!1)}async runScript(e){this.execScripts.get(e.uuid)&&await this.stopScript(e.uuid);let t=R(e.code)||"",r=L(e.code)||"",n=eo(r),s={...e,metadataStr:t,userConfigStr:r,userConfig:n};return this.execScript(s,!0)}valueUpdate(e){this.execScripts.forEach(t=>{(t.scriptRes.uuid===e.uuid||k(t.scriptRes)===e.storageName)&&t.valueUpdate(e)}),this.crontabSripts.forEach(t=>{(t.uuid===e.uuid||k(t)===e.storageName)&&(t.value[e.key]=e.value)})}emitEvent(e){let t=this.execScripts.get(e.uuid);t&&t.emitEvent(e.event,e.eventId,e.data)}init(){this.api.on("enableScript",this.enableScript.bind(this)),this.api.on("disableScript",this.disableScript.bind(this)),this.api.on("runScript",this.runScript.bind(this)),this.api.on("stopScript",this.stopScript.bind(this)),this.api.on("runtime/valueUpdate",this.valueUpdate.bind(this)),this.api.on("runtime/emitEvent",this.emitEvent.bind(this))}constructor(e,t){ei(this,"windowMessage",void 0),ei(this,"api",void 0),ei(this,"cronJob",void 0),ei(this,"execScripts",void 0),ei(this,"logger",void 0),ei(this,"retryList",void 0),ei(this,"crontabSripts",void 0),this.windowMessage=e,this.api=t,this.cronJob=new Map,this.execScripts=new Map,this.retryList=[],this.crontabSripts=[],this.logger=v.getInstance().logger({component:"sandbox"}),setInterval(()=>{if(!this.retryList.length)return;let e=Date.now(),t=[];for(let r=0;r<this.retryList.length;r+=1){let n=this.retryList[r];n.retryTime<e&&(this.retryList.splice(r,1),r-=1,t.push(n.script))}for(let e of t)e.nextruntime=0,this.execScript(e)},5e3)}}function el(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}let ec=new class e{messageHandle(e,t){"sendMessage"===e.type?this.EE.emit("message",e.data,r=>{if(!e.messageId)return;let n={messageId:e.messageId,type:"respMessage",data:r};t.postMessage(n)}):"respMessage"===e.type?this.EE.emit(`response:${e.messageId}`,e):"connect"===e.type?this.EE.emit("connect",e.data,new d(e.messageId,this.EE,t)):"disconnect"===e.type?this.EE.emit(`disconnect:${e.messageId}`):"connectMessage"===e.type&&this.EE.emit(`connectMessage:${e.messageId}`,e.data)}onConnect(e){this.EE.addListener("connect",e)}connect(e){return new Promise(t=>{let r={messageId:a(),type:"connect",data:e};this.target.postMessage(r,"*"),t(new d(r.messageId,this.EE,this.target))})}onMessage(e){this.EE.addListener("message",e)}sendMessage(e){return new Promise(t=>{let r={messageId:a(),type:"sendMessage",data:e},n=`response:${r.messageId}`,s=e=>{null!==s&&(this.EE.removeListener(n,s),t(e.data),s=null,t=null)};this.EE.addListener(n,s),this.target.postMessage(r,"*")})}constructor(e,t,r){c(this,"source",void 0),c(this,"target",void 0),c(this,"serviceWorker",void 0),c(this,"EE",void 0),this.source=e,this.target=t,this.serviceWorker=r,this.EE=new l,this.source.addEventListener("message",e=>{(e.source===this.target||e.source===this.source)&&this.messageHandle(e.data,new u(this.target))}),this.serviceWorker&&navigator.serviceWorker.addEventListener("message",e=>{e.source&&this.messageHandle(e.data,e.source)})}}(window,parent);new v({writer:new class e{write(e,t,r){this.send.sendMessage({action:this.action,data:{id:0,level:e,message:t,label:r,createtime:Date.now()}})}constructor(e,t="logger"){M(this,"action",void 0),M(this,"send",void 0),this.action=t,this.send=e}}(ec,"offscreen/logger"),labels:{env:"sandbox"}}).logger().debug("offscreen start"),new class e{initManager(){new ea(this.windowMessage,this.api).init(),b(this.windowMessage,"offscreen/preparationSandbox")}constructor(e){el(this,"windowMessage",void 0),el(this,"api",void 0),this.windowMessage=e,this.api=new G("sandbox",this.windowMessage)}}(ec).initManager()},86503:function(){}},t={};function r(n){var s=t[n];if(void 0!==s)return s.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,r),o.exports}r.m=e,r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.g=(()=>{if("object"==typeof globalThis)return globalThis;try{return this||Function("return this")()}catch(e){if("object"==typeof window)return window}})(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{var e=[];r.O=(t,n,s,o)=>{if(n){o=o||0;for(var i=e.length;i>0&&e[i-1][2]>o;i--)e[i]=e[i-1];e[i]=[n,s,o];return}for(var a=1/0,i=0;i<e.length;i++){for(var[n,s,o]=e[i],l=!0,c=0;c<n.length;c++)(!1&o||a>=o)&&Object.keys(r.O).every(e=>r.O[e](n[c]))?n.splice(c--,1):(l=!1,o<a&&(a=o));if(l){e.splice(i--,1);var u=s();void 0!==u&&(t=u)}}return t}})(),r.rv=()=>"1.4.4",(()=>{var e={6723:0};r.O.j=t=>0===e[t];var t=(t,n)=>{var s,o,[i,a,l]=n,c=0;if(i.some(t=>0!==e[t])){for(s in a)r.o(a,s)&&(r.m[s]=a[s]);if(l)var u=l(r)}for(t&&t(n);c<i.length;c++)o=i[c],r.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return r.O(u)},n=self.webpackChunkscriptcat=self.webpackChunkscriptcat||[];n.forEach(t.bind(null,0)),n.push=t.bind(null,n.push.bind(n))})(),r.ruid="bundler=rspack@1.4.4";var n=r.O(void 0,["3641"],function(){return r(15705)});n=r.O(n)})();