(()=>{"use strict";var e={70864:function(e){var t=Object.prototype.hasOwnProperty,s="~";function r(){}function n(e,t,s){this.fn=e,this.context=t,this.once=s||!1}function i(e,t,r,i,o){if("function"!=typeof r)throw TypeError("The listener must be a function");var a=new n(r,i||e,o),c=s?s+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],a]:e._events[c].push(a):(e._events[c]=a,e._eventsCount++),e}function o(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function a(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(s=!1)),a.prototype.eventNames=function(){var e,r,n=[];if(0===this._eventsCount)return n;for(r in e=this._events)t.call(e,r)&&n.push(s?r.slice(1):r);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},a.prototype.listeners=function(e){var t=s?s+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var n=0,i=r.length,o=Array(i);n<i;n++)o[n]=r[n].fn;return o},a.prototype.listenerCount=function(e){var t=s?s+e:e,r=this._events[t];return r?r.fn?1:r.length:0},a.prototype.emit=function(e,t,r,n,i,o){var a=s?s+e:e;if(!this._events[a])return!1;var c,l,h=this._events[a],d=arguments.length;if(h.fn){switch(h.once&&this.removeListener(e,h.fn,void 0,!0),d){case 1:return h.fn.call(h.context),!0;case 2:return h.fn.call(h.context,t),!0;case 3:return h.fn.call(h.context,t,r),!0;case 4:return h.fn.call(h.context,t,r,n),!0;case 5:return h.fn.call(h.context,t,r,n,i),!0;case 6:return h.fn.call(h.context,t,r,n,i,o),!0}for(l=1,c=Array(d-1);l<d;l++)c[l-1]=arguments[l];h.fn.apply(h.context,c)}else{var u,g=h.length;for(l=0;l<g;l++)switch(h[l].once&&this.removeListener(e,h[l].fn,void 0,!0),d){case 1:h[l].fn.call(h[l].context);break;case 2:h[l].fn.call(h[l].context,t);break;case 3:h[l].fn.call(h[l].context,t,r);break;case 4:h[l].fn.call(h[l].context,t,r,n);break;default:if(!c)for(u=1,c=Array(d-1);u<d;u++)c[u-1]=arguments[u];h[l].fn.apply(h[l].context,c)}}return!0},a.prototype.on=function(e,t,s){return i(this,e,t,s,!1)},a.prototype.once=function(e,t,s){return i(this,e,t,s,!0)},a.prototype.removeListener=function(e,t,r,n){var i=s?s+e:e;if(!this._events[i])return this;if(!t)return o(this,i),this;var a=this._events[i];if(a.fn)a.fn!==t||n&&!a.once||r&&a.context!==r||o(this,i);else{for(var c=0,l=[],h=a.length;c<h;c++)(a[c].fn!==t||n&&!a[c].once||r&&a[c].context!==r)&&l.push(a[c]);l.length?this._events[i]=1===l.length?l[0]:l:o(this,i)}return this},a.prototype.removeAllListeners=function(e){var t;return e?(t=s?s+e:e,this._events[t]&&o(this,t)):(this._events=new r,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=s,a.EventEmitter=a,e.exports=a}},t={};function s(r){var n=t[r];if(void 0!==n)return n.exports;var i=t[r]={exports:{}};return e[r](i,i.exports,s),i.exports}s.rv=()=>"1.4.4",s.ruid="bundler=rspack@1.4.4",(()=>{let e,t=/YYYY|MM|DD|HH|mm|ss/g;function r(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}let n={none:0,trace:10,debug:100,info:1e3,warn:1e4,error:1e5};class i{log(e,s){let r;for(var i=arguments.length,o=Array(i>2?i-2:0),a=2;a<i;a++)o[a-2]=arguments[a];let c=function(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];let r={};return t.forEach(e=>{e.forEach(e=>{Object.keys(e).forEach(t=>{r[t]=e[t]})})}),r}(this.label,o);n[e]>=n[this.core.level]&&this.core.writer.write(e,s,c);try{r=JSON.stringify(c)}catch(e){r=c,console.error("Logger label JSON stringify error:",e)}if("none"!==this.core.consoleLevel&&n[e]>=n[this.core.consoleLevel]){"object"==typeof s&&(s=JSON.stringify(s));let n=`${function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Date,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"YYYY-MM-DD HH:mm:ss";return s.replace(t,t=>{switch(t){case"YYYY":return e.getFullYear().toString();case"MM":{let t=e.getMonth()+1;return t<10?"0"+t:t.toString()}case"DD":{let t=e.getDate();return t<10?"0"+t:t.toString()}case"HH":{let t=e.getHours();return t<10?"0"+t:t.toString()}case"mm":{let t=e.getMinutes();return t<10?"0"+t:t.toString()}case"ss":{let t=e.getSeconds();return t<10?"0"+t:t.toString()}}return t})}(new Date,"YYYY-MM-DD HH:mm:ss")} [${e}] ${s}`;switch(e){case"error":console.error(n,r);break;case"warn":console.warn(n,r);break;default:console.info(n,r)}}}with(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return new i(this.core,...this.label,...t)}trace(e){for(var t=arguments.length,s=Array(t>1?t-1:0),r=1;r<t;r++)s[r-1]=arguments[r];this.log("trace",e,...s)}debug(e){for(var t=arguments.length,s=Array(t>1?t-1:0),r=1;r<t;r++)s[r-1]=arguments[r];this.log("debug",e,...s)}info(e){for(var t=arguments.length,s=Array(t>1?t-1:0),r=1;r<t;r++)s[r-1]=arguments[r];this.log("info",e,...s)}warn(e){for(var t=arguments.length,s=Array(t>1?t-1:0),r=1;r<t;r++)s[r-1]=arguments[r];this.log("warn",e,...s)}error(e){for(var t=arguments.length,s=Array(t>1?t-1:0),r=1;r<t;r++)s[r-1]=arguments[r];this.log("error",e,...s)}static E(e){return"string"==typeof e?{error:e}:e instanceof Error?(console.error(e),{error:e.message}):"object"==typeof e?e:{}}constructor(e,...t){r(this,"core",void 0),r(this,"label",void 0),this.core=e,this.label=t}}function o(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class a{static getInstance(){return a.instance}static logger(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return a.getInstance().logger(...t)}logger(){for(var e=arguments.length,t=Array(e),s=0;s<e;s++)t[s]=arguments[s];return new i(this,this.labels,...t)}constructor(e){o(this,"writer",void 0),o(this,"level","info"),o(this,"consoleLevel","warn"),o(this,"labels",void 0),this.writer=e.writer,this.level=e.level||this.level,this.labels=e.labels||{},void 0!==e.consoleLevel&&(this.consoleLevel=e.consoleLevel),a.instance||(a.instance=this)}}function c(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}o(a,"instance",void 0);class l{write(e,t,s){this.send.sendMessage({action:this.action,data:{id:0,level:e,message:t,label:s,createtime:Date.now()}})}constructor(e,t="logger"){c(this,"action",void 0),c(this,"send",void 0),this.action=t,this.send=e}}function h(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}async function d(e,t,s){let r=await e.sendMessage({action:t,data:s}),n=a.getInstance().logger().with({action:t,data:s,response:r});if(n.trace("sendMessage"),null==r?void 0:r.code)throw console.error(r),r.message;try{return r.data}catch(e){n.trace("Invalid response data",i.E(e));return}}class u{do(e,t){return d(this.msg,`${this.prefix}${e}`,t)}async doThrow(e,t){let s=await d(this.msg,`${this.prefix}${e}`,t);if(!s)throw Error(`doThrow: ${this.prefix}${e}`);return s}constructor(e,t){h(this,"msg",void 0),h(this,"prefix",void 0),this.msg=e,this.prefix=t,this.prefix&&!this.prefix.endsWith("/")?this.prefix+="/":this.prefix=""}}class g{connect(e){return new Promise(t=>{let s=chrome.runtime.connect();s.postMessage(e),t(new p(s))})}sendMessage(e){return new Promise(t=>{chrome.runtime.sendMessage(e,e=>{let s=chrome.runtime.lastError;if(s){console.error("chrome.runtime.lastError in chrome.runtime.sendMessage:",s),t=null;return}t(e),t=null})})}constructor(){}}class p{sendMessage(e){this.con.postMessage(e)}onMessage(e){this.con.onMessage.addListener(e)}disconnect(){this.con.disconnect()}onDisconnect(e){this.con.onDisconnect.addListener(e)}getPort(){return this.con}constructor(e){!function(e,t,s){"con"in e?Object.defineProperty(e,"con",{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s}(this,"con",void 0),this.con=e}}function f(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class m{getSender(){return this.sender instanceof p?this.sender.getPort().sender:this.sender}getExtMessageSender(){var e,t,s,r,n,i,o,a;if(this.sender instanceof p){let e=this.sender.getPort();return{windowId:(null==(r=e.sender)||null==(s=r.tab)?void 0:s.windowId)||-1,tabId:(null==(i=e.sender)||null==(n=i.tab)?void 0:n.id)||-1,frameId:null==(o=e.sender)?void 0:o.frameId,documentId:null==(a=e.sender)?void 0:a.documentId}}let c=this.sender;return{windowId:(null==(e=c.tab)?void 0:e.windowId)||-1,tabId:(null==(t=c.tab)?void 0:t.id)||-1,frameId:c.frameId,documentId:c.documentId}}getConnect(){return this.sender}constructor(e){f(this,"sender",void 0),this.sender=e}}class v{group(e,t){return new w(this,e,t)}on(e,t){this.apiFunctionMap.set(e,t)}connectHandle(e,t,s){let r=this.apiFunctionMap.get(e);if(r){let e=r(t,new m(s));return e&&(e instanceof Promise?e.then(e=>{e&&s.sendMessage({code:0,data:e})}).catch(e=>{s.sendMessage({code:-1,message:e.message||e.toString()}),this.logger.error("connectHandle error",i.E(e))}):s.sendMessage({code:0,data:e})),!0}}messageHandle(e,t,s,r){let n=this.apiFunctionMap.get(e);if(n)try{let e=n(t,new m(r));if(e instanceof Promise)return e.then(e=>{try{s({code:0,data:e})}catch(e){this.logger.error("sendResponse error",i.E(e))}}).catch(e=>{s({code:-1,message:e.message||e.toString()}),this.logger.error("messageHandle error",i.E(e))}),!0;s({code:0,data:e})}catch(e){s({code:-1,message:e.message||e.toString()}),this.logger.error("messageHandle error",i.E(e))}else s({code:-1,message:"no such api "+e}),this.logger.error("no such api",{action:e})}constructor(e,t,s=!0){f(this,"enableConnect",void 0),f(this,"apiFunctionMap",void 0),f(this,"logger",void 0),this.enableConnect=s,this.apiFunctionMap=new Map,this.logger=a.getInstance().logger({service:"messageServer"}),this.enableConnect&&t.onConnect((t,s)=>{var r;if("string"==typeof t.action)return this.logger.trace("server onConnect",{msg:t}),null!=(r=t.action)&&!!r.startsWith(e)&&this.connectHandle(t.action.slice(e.length+1),t.data,s)}),t.onMessage((t,s,r)=>{var n;if("string"==typeof t.action)return this.logger.trace("server onMessage",{msg:t}),null!=(n=t.action)&&!!n.startsWith(e)&&this.messageHandle(t.action.slice(e.length+1),t.data,s,r)})}}class w{group(e,t){let s=new w(this.server,`${this.name}${e}`,t);return s.middlewares=[...this.middlewares,...s.middlewares],s}use(e){let t=new w(this.server,`${this.name}`,e);return t.middlewares=[...this.middlewares,...t.middlewares],t}on(e,t){let s=`${this.name}${e}`;0===this.middlewares.length?this.server.on(s,t):this.server.on(s,async(e,s)=>{let r=0,n=async()=>{if(!(r<this.middlewares.length))return await t(e,s);{let t=this.middlewares[r++];return await t(e,s,n)}};return await n()})}constructor(e,t,s){f(this,"server",void 0),f(this,"name",void 0),f(this,"middlewares",void 0),this.server=e,this.name=t,this.middlewares=[],!t.endsWith("/")&&t.length>0&&(this.name+="/"),s&&this.middlewares.push(s)}}function b(e,t,s,r,n){let i=(s,n)=>{var i;let o=n.getConnect();if(!o)return d(r,e+"/"+t,s);(i=`${e}/${t}`,r.connect({action:i,data:s})).then(e=>{o.onMessage(t=>{e.sendMessage(t)}),e.onMessage(e=>{o.sendMessage(e)}),o.onDisconnect(()=>{e.disconnect()}),e.onDisconnect(()=>{o.disconnect()})})};s.on(t,(e,t)=>{if(n){let s=n(e,t);if(s instanceof Promise)return s.then(s=>!1!==s?s:i(e,t));if(!1!==s)return s}return i(e,t)})}let y={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)},E=new Uint8Array(16),M=[];for(let e=0;e<256;++e)M.push((e+256).toString(16).slice(1));function x(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(M[e[t+0]]+M[e[t+1]]+M[e[t+2]]+M[e[t+3]]+"-"+M[e[t+4]]+M[e[t+5]]+"-"+M[e[t+6]]+M[e[t+7]]+"-"+M[e[t+8]]+M[e[t+9]]+"-"+M[e[t+10]]+M[e[t+11]]+M[e[t+12]]+M[e[t+13]]+M[e[t+14]]+M[e[t+15]]).toLowerCase()}let S=function(t,s,r){var n;if(y.randomUUID&&!s&&!t)return y.randomUUID();let i=(t=t||{}).random??(null==(n=t.rng)?void 0:n.call(t))??function(){if(!e){if("undefined"==typeof crypto||!crypto.getRandomValues)throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");e=crypto.getRandomValues.bind(crypto)}return e(E)}();if(i.length<16)throw Error("Random bytes length must be >= 16");if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,s){if((r=r||0)<0||r+16>s.length)throw RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let e=0;e<16;++e)s[r+e]=i[e];return s}return x(i)};class C{get(e){return new Promise(t=>{chrome.storage.session.get(e,s=>{let r=chrome.runtime.lastError;r&&console.error("chrome.runtime.lastError in chrome.storage.session.get:",r),t(s[e])})})}set(e,t){return new Promise(s=>{chrome.storage.session.set({[e]:t},()=>{let e=chrome.runtime.lastError;e&&console.error("chrome.runtime.lastError in chrome.storage.session.set:",e),s()})})}batchSet(e){return new Promise(t=>{chrome.storage.session.set(e,()=>{let e=chrome.runtime.lastError;e&&console.error("chrome.runtime.lastError in chrome.storage.session.set:",e),t()})})}has(e){return new Promise(t=>{chrome.storage.session.get(e,s=>{let r=chrome.runtime.lastError;r&&console.error("chrome.runtime.lastError in chrome.storage.session.get:",r),t(void 0!==s[e])})})}del(e){return new Promise(t=>{chrome.storage.session.remove(e,()=>{let e=chrome.runtime.lastError;e&&console.error("chrome.runtime.lastError in chrome.storage.session.remove:",e),t()})})}clear(){return new Promise(e=>{chrome.storage.session.clear(()=>{let t=chrome.runtime.lastError;t&&console.error("chrome.runtime.lastError in chrome.storage.session.clear:",t),e()})})}list(){return new Promise(e=>{chrome.storage.session.get(null,t=>{let s=chrome.runtime.lastError;s&&console.error("chrome.runtime.lastError in chrome.storage.session.get:",s),e(Object.keys(t))})})}}new class extends C{async getOrSet(e,t){let s=await this.get(e);return s||(s=await t(),this.set(e,s)),s}lock(e){let t=this.txLock.has(e),s=()=>{var t;let r=null==(t=this.txLock.get(e))?void 0:t.shift();r?r(s):this.txLock.delete(e)};if(t){let t=this.txLock.get(e);return t||(t=[],this.txLock.set(e,t)),new Promise(e=>{t.push(e)})}return this.txLock.set(e,[]),s}async tx(e,t){let s,r=await this.lock(e);return await this.get(e).then(e=>t(e)).then(t=>t?(s=t,this.set(e,t)):void 0===t?this.del(e):void 0),r(),s}incr(e,t){return this.tx(e,e=>(e||0)+t)}constructor(...e){super(...e),function(e,t,s){t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s}(this,"txLock",new Map)}};class I extends u{preparationOffscreen(){return this.do("preparationOffscreen")}constructor(e){super(e,"serviceWorker")}}class R extends u{getAllScripts(){return this.doThrow("getAllScripts")}getInstallInfo(e){return this.do("getInstallInfo",e)}install(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"user";return this.doThrow("install",{script:e,code:t,upsertBy:s})}delete(e){return this.do("delete",e)}enable(e,t){return this.do("enable",{uuid:e,enable:t})}info(e){return this.doThrow("fetchInfo",e)}getFilterResult(e){return this.do("getFilterResult",e)}getScriptRunResource(e){return this.doThrow("getScriptRunResource",e)}excludeUrl(e,t,s){return this.do("excludeUrl",{uuid:e,excludePattern:t,remove:s})}resetMatch(e,t){return this.do("resetMatch",{uuid:e,match:t})}resetExclude(e,t){return this.do("resetExclude",{uuid:e,exclude:t})}requestCheckUpdate(e){return this.do("requestCheckUpdate",e)}sortScript(e,t){return this.do("sortScript",{active:e,over:t})}importByUrl(e){return this.do("importByUrl",e)}installByCode(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"user";return this.do("installByCode",{uuid:e,code:t,upsertBy:s})}async formatUrl(e){try{let{hostname:t,pathname:s}=new URL(e.replace(/\/$/,""));if(!("scriptcat.org"===t&&/script-show-page\/\d+$/.test(s)))return e;{let e=s.match(/\d+$/)[0],{code:t,data:r,msg:n}=await fetch(`https://scriptcat.org/api/v2/scripts/${e}`).then(e=>e.json()).then(e=>e);if(0!==t)return{success:!1,msg:n};{let t=r.name;return`https://scriptcat.org/scripts/code/${e}/${t}.user.js`}}}catch{return e}}async importByUrls(e){if(0==e.length)return;let t=await Promise.allSettled(e.map(async e=>{let t=await this.formatUrl(e);return t instanceof Object?await Promise.resolve(t):await this.do("importByUrl",t)})),s={success:0,fail:0,msg:[]};return t.forEach((e,t)=>{let{value:r}=e;r.success?s.success++:(s.fail++,s.msg.push(`#${t+1}: ${r.msg}`))}),s}setCheckUpdateUrl(e,t,s){return this.do("setCheckUpdateUrl",{uuid:e,checkUpdate:t,checkUpdateUrl:s})}updateMetadata(e,t,s){return this.do("updateMetadata",{uuid:e,key:t,value:s})}constructor(e){super(e,"serviceWorker/script")}}class L extends u{getScriptResources(e){return this.doThrow("getScriptResources",e)}deleteResource(e){return this.do("deleteResource",e)}constructor(e){super(e,"serviceWorker/resource")}}class U extends u{getScriptValue(e){return this.doThrow("getScriptValue",e)}setScriptValue(e,t,s){return this.do("setScriptValue",{uuid:e,key:t,value:s})}setScriptValues(e,t){return this.do("setScriptValues",{uuid:e,values:t})}constructor(e){super(e,"serviceWorker/value")}}function T(e,t){return d(e,"sandbox/enableScript",t)}function k(e,t){return d(e,"sandbox/disableScript",t)}function $(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class O{runScript(e){d(this.windowMessage,"sandbox/runScript",e)}stopScript(e){d(this.windowMessage,"sandbox/stopScript",e)}async init(){this.messageQueue.subscribe("enableScript",async e=>{let t=await this.scriptClient.info(e.uuid);1!==t.type&&(e.enable?T(this.windowMessage,await this.scriptClient.getScriptRunResource(t)):k(this.windowMessage,t.uuid))}),this.messageQueue.subscribe("installScript",async e=>{1!==e.script.type&&(1===e.script.status?T(this.windowMessage,await this.scriptClient.getScriptRunResource(e.script)):k(this.windowMessage,e.script.uuid))}),this.messageQueue.subscribe("deleteScript",async e=>{k(this.windowMessage,e.uuid)}),this.group.on("runScript",this.runScript.bind(this)),this.group.on("stopScript",this.stopScript.bind(this))}constructor(e,t,s,r){$(this,"group",void 0),$(this,"extensionMessage",void 0),$(this,"windowMessage",void 0),$(this,"messageQueue",void 0),$(this,"logger",void 0),$(this,"scriptClient",void 0),$(this,"resourceClient",void 0),$(this,"valueClient",void 0),this.group=e,this.extensionMessage=t,this.windowMessage=s,this.messageQueue=r,this.scriptClient=new R(this.extensionMessage),this.resourceClient=new L(this.extensionMessage),this.valueClient=new U(this.extensionMessage),this.logger=a.logger().with({service:"script"})}}var P=s(70864);function D(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class j{postMessage(e){this.target.postMessage(e,"*")}constructor(e){D(this,"target",void 0),this.target=e}}class A{messageHandle(e,t){"sendMessage"===e.type?this.EE.emit("message",e.data,s=>{if(!e.messageId)return;let r={messageId:e.messageId,type:"respMessage",data:s};t.postMessage(r)}):"respMessage"===e.type?this.EE.emit(`response:${e.messageId}`,e):"connect"===e.type?this.EE.emit("connect",e.data,new H(e.messageId,this.EE,t)):"disconnect"===e.type?this.EE.emit(`disconnect:${e.messageId}`):"connectMessage"===e.type&&this.EE.emit(`connectMessage:${e.messageId}`,e.data)}onConnect(e){this.EE.addListener("connect",e)}connect(e){return new Promise(t=>{let s={messageId:S(),type:"connect",data:e};this.target.postMessage(s,"*"),t(new H(s.messageId,this.EE,this.target))})}onMessage(e){this.EE.addListener("message",e)}sendMessage(e){return new Promise(t=>{let s={messageId:S(),type:"sendMessage",data:e},r=`response:${s.messageId}`,n=e=>{null!==n&&(this.EE.removeListener(r,n),t(e.data),n=null,t=null)};this.EE.addListener(r,n),this.target.postMessage(s,"*")})}constructor(e,t,s){D(this,"source",void 0),D(this,"target",void 0),D(this,"serviceWorker",void 0),D(this,"EE",void 0),this.source=e,this.target=t,this.serviceWorker=s,this.EE=new P,this.source.addEventListener("message",e=>{(e.source===this.target||e.source===this.source)&&this.messageHandle(e.data,new j(this.target))}),this.serviceWorker&&navigator.serviceWorker.addEventListener("message",e=>{e.source&&this.messageHandle(e.data,e.source)})}}class H{sendMessage(e){let t={messageId:this.messageId,type:"connectMessage",data:e};this.target.postMessage(t)}onMessage(e){this.EE.addListener(`connectMessage:${this.messageId}`,e)}disconnect(){let e={messageId:this.messageId,type:"disconnect",data:null};this.target.postMessage(e)}onDisconnect(e){this.EE.addListener(`disconnect:${this.messageId}`,e)}constructor(e,t,s){D(this,"messageId",void 0),D(this,"EE",void 0),D(this,"target",void 0),this.messageId=e,this.EE=t,this.target=s,this.onDisconnect(()=>{this.EE.removeAllListeners("connectMessage:"+this.messageId),this.EE.removeAllListeners("disconnect:"+this.messageId)})}}function _(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class W{async dealXhrResponse(e,t,s,r,n){let o={finalUrl:r.responseURL||t.url,readyState:r.readyState,status:r.status,statusText:r.statusText,responseHeaders:r.getAllResponseHeaders(),responseType:t.responseType};if(4===r.readyState){var c,l;let e=null==(c=t.responseType)?void 0:c.toLowerCase();if("arraybuffer"===e||"blob"===e){let e=r.response;if(null===e)o.response=null;else{let t;t=e instanceof ArrayBuffer?new Blob([e]):e,o.response=URL.createObjectURL(t);try{(null==(l=r.getResponseHeader("Content-Type"))?void 0:l.includes("text"))&&(o.responseText=await t.text())}catch(e){a.logger(i.E(e)).error("GM XHR getResponseHeader error")}setTimeout(()=>{URL.revokeObjectURL(o.response)},6e4)}}else if("json"===o.responseType){try{o.response=JSON.parse(r.responseText)}catch(e){a.logger(i.E(e)).error("GM XHR JSON parse error")}try{o.responseText=r.responseText}catch(e){a.logger(i.E(e)).error("GM XHR getResponseText error")}}else{try{o.response=r.response}catch(e){a.logger(i.E(e)).error("GM XHR response error")}try{o.responseText=r.responseText||void 0}catch(e){a.logger(i.E(e)).error("GM XHR getResponseText error")}}}return n&&(o=Object.assign(o,n)),e.sendMessage({action:s,data:o}),o}async xmlHttpRequest(e,t){if("stream"===e.responseType)throw Error("Method not implemented.");let s=new XMLHttpRequest,r=t.getConnect();if(s.open(e.method||"GET",e.url,!0,e.user||"",e.password||""),e.headers)for(let t in e.headers)s.setRequestHeader(t,e.headers[t]);if(e.timeout&&(s.timeout=e.timeout),e.overrideMimeType&&s.overrideMimeType(e.overrideMimeType),"json"!==e.responseType&&(s.responseType=e.responseType||""),s.onload=()=>{this.dealXhrResponse(r,e,"onload",s)},s.onloadstart=()=>{this.dealXhrResponse(r,e,"onloadstart",s)},s.onloadend=()=>{this.dealXhrResponse(r,e,"onloadend",s)},s.onabort=()=>{this.dealXhrResponse(r,e,"onabort",s)},s.onerror=()=>{this.dealXhrResponse(r,e,"onerror",s)},s.onprogress=t=>{let n={done:s.DONE,lengthComputable:t.lengthComputable,loaded:t.loaded,total:t.total,totalSize:t.total};this.dealXhrResponse(r,e,"onprogress",s,n)},s.onreadystatechange=()=>{this.dealXhrResponse(r,e,"onreadystatechange",s)},s.ontimeout=()=>{null==r||r.sendMessage({action:"ontimeout",data:{}})},"FormData"===e.dataType){let t=new FormData;e.data&&e.data instanceof Array&&(await Promise.all(e.data.map(e=>{if("file"===e.type)return fetch(e.val).then(e=>e.blob()).then(s=>{let r=new File([s],e.filename);t.append(e.key,r,e.filename)});t.append(e.key,e.val)})),s.send(t))}else if("Blob"===e.dataType){if(!e.data)throw Error("Blob data is empty");let t=await (await fetch(e.data)).blob();s.send(t)}else s.send(e.data);null==r||r.onDisconnect(()=>{s.abort()})}async openInTab(e){let{url:t}=e;return void 0!==window.open(t)}async setClipboard(e){let{data:t,type:s}=e;this.clipboardData={type:s,data:t},this.textarea.focus(),document.execCommand("copy",!1,null)}init(){this.textarea.style.display="none",document.documentElement.appendChild(this.textarea),document.addEventListener("copy",e=>{if(!this.clipboardData||!e.clipboardData)return;e.preventDefault();let{type:t,data:s}=this.clipboardData;e.clipboardData.setData(t||"text/plain",s),this.clipboardData=void 0}),this.group.on("xmlHttpRequest",this.xmlHttpRequest.bind(this)),this.group.on("openInTab",this.openInTab.bind(this)),this.group.on("setClipboard",this.setClipboard.bind(this))}constructor(e){_(this,"group",void 0),_(this,"logger",void 0),_(this,"textarea",void 0),_(this,"clipboardData",void 0),this.group=e,this.logger=a.logger().with({service:"gmApi"}),this.textarea=document.createElement("textarea")}}function Q(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class V{handler(e,t){let{action:s,message:r}=t;if(a.getInstance().logger({service:"messageQueue"}).trace("messageQueueHandler",{action:s,topic:e,message:r}),"message"===s)this.EE.emit(e,r);else throw Error("action not found")}subscribe(e,t){return this.EE.on(e,t),()=>{this.EE.off(e,t)}}publish(e,t){chrome.runtime.sendMessage({msgQueue:e,data:{action:"message",message:t}}),this.EE.emit(e,t),a.getInstance().logger({service:"messageQueue"}).trace("publish",{topic:e,message:t})}emit(e,t){this.EE.emit(e,t)}group(e,t){return new Y(this,e,t)}constructor(){Q(this,"EE",new P),chrome.runtime.onMessage.addListener(e=>{let t=chrome.runtime.lastError,s=e.msgQueue;if("string"==typeof s){if(t)return console.error("chrome.runtime.lastError in chrome.runtime.onMessage:",t),!1;this.handler(s,e.data)}})}}class Y{group(e,t){let s=new Y(this.messageQueue,`${this.name}${e}`,t);return s.middlewares=[...this.middlewares,...s.middlewares],s}use(e){return this.middlewares.push(e),this}subscribe(e,t){let s=`${this.name}${e}`;if(0===this.middlewares.length)return this.messageQueue.subscribe(s,t);{let e=async e=>{let r=0,n=async()=>{if(r<this.middlewares.length){let t=(0,this.middlewares[r++])(s,e,n);t instanceof Promise&&await t}else t(e)};await n()};return this.messageQueue.subscribe(s,e)}}publish(e,t){let s=`${this.name}${e}`;this.messageQueue.publish(s,t)}emit(e,t){let s=`${this.name}${e}`;this.messageQueue.emit(s,t)}constructor(e,t,s){Q(this,"messageQueue",void 0),Q(this,"name",void 0),Q(this,"middlewares",void 0),this.messageQueue=e,this.name=t,this.middlewares=[],!t.endsWith("/")&&t.length>0&&(this.name+="/"),s&&this.middlewares.push(s)}}function X(e,t){return e<<t|e>>>32-t}let B=function(e){let t=[0x5a827999,0x6ed9eba1,0x8f1bbcdc,0xca62c1d6],s=[0x67452301,0xefcdab89,0x98badcfe,0x10325476,0xc3d2e1f0],r=new Uint8Array(e.length+1);r.set(e),r[e.length]=128;let n=Math.ceil(((e=r).length/4+2)/16),i=Array(n);for(let t=0;t<n;++t){let s=new Uint32Array(16);for(let r=0;r<16;++r)s[r]=e[64*t+4*r]<<24|e[64*t+4*r+1]<<16|e[64*t+4*r+2]<<8|e[64*t+4*r+3];i[t]=s}i[n-1][14]=(e.length-1)*8/0x100000000,i[n-1][14]=Math.floor(i[n-1][14]),i[n-1][15]=(e.length-1)*8|0;for(let e=0;e<n;++e){let r=new Uint32Array(80);for(let t=0;t<16;++t)r[t]=i[e][t];for(let e=16;e<80;++e)r[e]=X(r[e-3]^r[e-8]^r[e-14]^r[e-16],1);let n=s[0],o=s[1],a=s[2],c=s[3],l=s[4];for(let e=0;e<80;++e){let s=Math.floor(e/20),i=X(n,5)+function(e,t,s,r){switch(e){case 0:return t&s^~t&r;case 1:case 3:return t^s^r;case 2:return t&s^t&r^s&r}}(s,o,a,c)+l+t[s]+r[e]>>>0;l=c,c=a,a=X(o,30)>>>0,o=n,n=i}s[0]=s[0]+n>>>0,s[1]=s[1]+o>>>0,s[2]=s[2]+a>>>0,s[3]=s[3]+c>>>0,s[4]=s[4]+l>>>0}return Uint8Array.of(s[0]>>24,s[0]>>16,s[0]>>8,s[0],s[1]>>24,s[1]>>16,s[1]>>8,s[1],s[2]>>24,s[2]>>16,s[2]>>8,s[2],s[3]>>24,s[3]>>16,s[3]>>8,s[3],s[4]>>24,s[4]>>16,s[4]>>8,s[4])},F=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i,N=function(e){let t;if(!("string"==typeof e&&F.test(e)))throw TypeError("Invalid UUID");return Uint8Array.of((t=parseInt(e.slice(0,8),16))>>>24,t>>>16&255,t>>>8&255,255&t,(t=parseInt(e.slice(9,13),16))>>>8,255&t,(t=parseInt(e.slice(14,18),16))>>>8,255&t,(t=parseInt(e.slice(19,23),16))>>>8,255&t,(t=parseInt(e.slice(24,36),16))/0x10000000000&255,t/0x100000000&255,t>>>24&255,t>>>16&255,t>>>8&255,255&t)};function q(e,t,s,r){var n=t,i=r;let o="string"==typeof e?function(e){let t=new Uint8Array((e=unescape(encodeURIComponent(e))).length);for(let s=0;s<e.length;++s)t[s]=e.charCodeAt(s);return t}(e):e,a="string"==typeof n?N(n):n;if("string"==typeof n&&(n=N(n)),(null==n?void 0:n.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let c=new Uint8Array(16+o.length);if(c.set(a),c.set(o,a.length),(c=B(c))[6]=15&c[6]|80,c[8]=63&c[8]|128,s){i=i||0;for(let e=0;e<16;++e)s[i+e]=c[e];return s}return x(c)}function G(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}q.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",q.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8";class J{connect(e){let{url:t,reconnect:s}=e;this.wsConnect&&this.wsConnect.close(),this.connectVSCodeTimer&&(clearInterval(this.connectVSCodeTimer),this.connectVSCodeTimer=void 0);let r=()=>this.wsConnect?Promise.resolve():this.connectVSCode({url:t});return s&&(this.connectVSCodeTimer=setInterval(()=>{r()},3e4)),r()}connectVSCode(e){let{url:t}=e;return new Promise((e,s)=>{this.wsConnect&&this.wsConnect.close();try{this.wsConnect=new WebSocket(t)}catch(e){this.logger.debug("connect vscode faild",i.E(e)),s(e);return}let r=!1;this.wsConnect.addEventListener("open",()=>{this.wsConnect.send('{"action":"hello"}'),r=!0,e()}),this.wsConnect.addEventListener("message",async e=>{let t=JSON.parse(e.data);if("onchange"===t.action){let e=t.data.script;this.scriptClient.installByCode(q(t.data.uri,q.URL),e,"vscode")}}),this.wsConnect.addEventListener("error",e=>{this.wsConnect=void 0,this.logger.debug("connect vscode faild",i.E(e)),r||s(Error("connect fail"))}),this.wsConnect.addEventListener("close",()=>{this.wsConnect=void 0,this.logger.debug("vscode connection closed")})})}init(){this.group.on("connect",this.connect.bind(this))}constructor(e,t){G(this,"group",void 0),G(this,"send",void 0),G(this,"logger",void 0),G(this,"reconnect",void 0),G(this,"wsConnect",void 0),G(this,"connectVSCodeTimer",void 0),G(this,"scriptClient",void 0),this.group=e,this.send=t,this.logger=a.logger().with({service:"VSCodeConnect"}),this.reconnect=!1,this.scriptClient=new R(this.send)}}function z(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class K{logger(e){this.sendMessageToServiceWorker({action:"logger",data:e})}preparationSandbox(){this.serviceWorker.preparationOffscreen()}sendMessageToServiceWorker(e){return d(this.extensionMessage,`serviceWorker/${e.action}`,e.data)}async initManager(){this.windowServer.on("logger",this.logger.bind(this)),this.windowServer.on("preparationSandbox",this.preparationSandbox.bind(this)),this.windowServer.on("sendMessageToServiceWorker",this.sendMessageToServiceWorker.bind(this)),new O(this.windowServer.group("script"),this.extensionMessage,this.windowMessage,this.messageQueue).init(),b("serviceWorker","runtime/gmApi",this.windowServer,this.extensionMessage),b("sandbox","runtime/valueUpdate",this.windowServer,this.windowMessage),b("sandbox","runtime/emitEvent",this.windowServer,this.windowMessage),new W(this.windowServer.group("gmApi")).init(),new J(this.windowServer.group("vscodeConnect"),this.extensionMessage).init(),this.windowServer.on("createObjectURL",async e=>{let t=URL.createObjectURL(e.data);return e.persistence||setTimeout(()=>{URL.revokeObjectURL(t)},6e4),t})}constructor(e){z(this,"extensionMessage",void 0),z(this,"windowMessage",void 0),z(this,"windowServer",void 0),z(this,"messageQueue",void 0),z(this,"serviceWorker",void 0),this.extensionMessage=e,this.windowMessage=new A(window,sandbox,!0),this.windowServer=new v("offscreen",this.windowMessage),this.messageQueue=new V,this.serviceWorker=new I(this.extensionMessage)}}!function(){let e=new g;new a({writer:new l(e,"serviceWorker/logger"),labels:{env:"offscreen"}}).logger().debug("offscreen start"),new K(e).initManager()}()})()})();